<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Doctor Dashboard | Mini Health</title>
  <link rel="stylesheet" href="../styles/main.css" />
  <link rel="stylesheet" href="../styles/dashboard.css" />

  <style>
    /* Patient card styling */
    .patient-card {
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: 0.3s;
    }
    .patient-card:hover {
      transform: translateY(-4px);
    }
    .patient-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .loading {
      font-size: 16px;
      margin-top: 10px;
      color: #444;
    }
  </style>
</head>

<body>
  <!-- ğŸŒ NAVBAR -->
  <header class="navbar">
    <div class="logo">ğŸ’™ Mini Health</div>
    <nav>
      <a href="../index.html">Home</a>
      <a href="#" id="patientsLink">My Patients</a>
      <a href="#" id="appointmentsLink">Appointments</a>
      <a href="#" id="prescriptionsLink">Prescriptions</a>
      <button id="logoutBtn" class="btn">Logout</button>
    </nav>
  </header>

  <!-- ğŸ©º DASHBOARD CONTENT -->
  <main class="dashboard-content">
    <h1 id="doctorName">Welcome, Doctor ğŸ‘‹</h1>
    <p class="subtitle">Your professional workspace â€” manage patients, appointments, and prescriptions.</p>

    <!-- Quick Action Cards -->
    <section class="cards">
      <div class="card">
        <h3>ğŸ‘©â€âš•ï¸ Assigned Patients</h3>
        <p>View and manage all your registered patients and their health records.</p>
        <button id="viewPatientsBtn" class="btn primary">Open</button>
      </div>

      <div class="card">
        <h3>ğŸ©º Add Doctor Notes</h3>
        <p>Record observations, follow-up advice, and care instructions.</p>
        <a href="../records.html" class="btn primary">Add Notes</a>
      </div>

      <div class="card">
        <h3>ğŸ“… Appointments</h3>
        <p>Manage scheduled visits and check upcoming consultations.</p>
        <a href="../appointments.html" class="btn primary">View</a>
      </div>

      <div class="card">
        <h3>ğŸ’Š Prescriptions</h3>
        <p>Create and manage digital prescriptions for your patients.</p>
        <a href="../prescriptions.html" class="btn primary">Manage</a>
      </div>
    </section>

    <!-- ğŸ‘©â€âš•ï¸ Dynamic Patients Section -->
    <section id="patientList" class="patients-section" style="display:none;">
      <h2>ğŸ‘©â€âš•ï¸ My Patients</h2>
      <p id="patientCount" style="color:#666; margin-bottom:10px;"></p>

      <div id="patientsContainer" class="patient-grid"></div>
    </section>
  </main>

  <!-- ğŸ§  SCRIPT -->
  <script>
document.addEventListener("DOMContentLoaded", async () => {
  const doctorNameEl = document.getElementById("doctorName");
  const logoutBtn = document.getElementById("logoutBtn");
  const patientsContainer = document.getElementById("patientsContainer");
  const patientList = document.getElementById("patientList");
  const viewPatientsBtn = document.getElementById("viewPatientsBtn");
  const patientCount = document.getElementById("patientCount");

  const name = localStorage.getItem("name");
  const role = localStorage.getItem("role");
  const token = localStorage.getItem("token");

  if (role !== "doctor") {
    alert("Access denied! Only doctors can view this page.");
    window.location.href = "../login.html";
    return;
  }

  doctorNameEl.textContent = name ? `Welcome, Dr. ${name} ğŸ‘‹` : "Welcome, Doctor ğŸ‘‹";

  logoutBtn.addEventListener("click", () => {
    localStorage.clear();
    window.location.href = "../login.html";
  });

  // Toggle patient list
  let isOpen = false;

  viewPatientsBtn.addEventListener("click", async () => {
    isOpen = !isOpen;

    if (!isOpen) {
      patientList.style.display = "none";
      return;
    }

    patientList.style.display = "block";
    patientsContainer.innerHTML = `<p class="loading">Loading patients...</p>`;

    try {
      const res = await fetch("http://localhost:3000/doctor/patients", {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
        },
      });

      const data = await res.json();
      console.log("Patients data:", data);

      if (data.success && data.patients.length > 0) {
        patientCount.textContent = `Total: ${data.patients.length} patients`;

        patientsContainer.innerHTML = data.patients
          .map(
            (p) => `
          <div class="patient-card">
            <h3>${p.name}</h3>
            <p>${p.email}</p>
          </div>`
          )
          .join("");
      } else {
        patientCount.textContent = "";
        patientsContainer.innerHTML = "<p>No patients found.</p>";
      }
    } catch (err) {
      patientsContainer.innerHTML = "<p>âš ï¸ Failed to load patients.</p>";
      console.error("Error fetching patients:", err);
    }
  });
});
</script>

</body>
</html>
